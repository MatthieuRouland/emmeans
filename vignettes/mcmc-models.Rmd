---
title: "MCMC-based models in emmeans"
author: "Russ Lenth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MCMC-based models in emmeans}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, echo = FALSE, results = "hide", message = FALSE} 
require("emmeans") 
options(show.signif.stars = FALSE) 
knitr::opts_chunk$set(collapse = TRUE,
fig.width = 4.5) 
```

To illustrate **emmeans**'s support for models fitted using MCMC methods,
consider the `example_model` available in the **rstanarm** package. 
The example concerns CBPP, a serious disease of cattle in Ethiopia.
A generalized linear mixed model was fitted to the data using the
code below. We subsequently obtain its reference grid in the usual way.
<!--- I'm faking this; I actually saved the ref_grid in a system file --->
```{r eval = FALSE}
example_model <- rstanarm::stan_glmer(
    cbind(incidence, size - incidence) ~ size + period + (1|herd),
    data = lme4::cbpp, family = binomial,
    chains = 2, cores = 1, seed = 12345, iter = 500)
rst_ex.rg <- ref_grid(example_model)
```
<!--- here's the system file with the ref_grid --->
```{r echo = FALSE}
load(system.file("extdata", "rstex.RData", package = "emmeans"))
rst_ex.rg <- do.call(emmobj, rstex)
```
Here is the structure of the reference grid:
```{r}
rst_ex.rg
```
And, again in the usual way, we can obtain EMMs:
```{r}
period.emm <- emmeans(rst_ex.rg, "period")
period.emm
```
The summary shows a frequentist summary of the EMMs. Under the hood, though, is a posterior sample of 500 sets of EMMs -- each one being the EMMs computed from each set of parameter values in the posterior sample of regression coefficients. The summary we see is based on the sample means and covariances of that sample.

We can access these posterior results via the `as.mcmc` method for `emm` objects.
This gives us an object of class `mcmc` (defined in the **coda** package), which
can be summarized and explored as we please.
```{r}
require("coda")  ### needed to access generic for as.mcmc()
summary(as.mcmc(period.emm))
```
Note that `as.mcmc` will actually produce an `mcmc.list` when there is more than
one chain present, as in this example.
The 2.5th and 97.5th quantiles are similar, but not identical, to the
95% confidence intervals in the frequentist summary. Here is a plot of
the posterior EMMs, back-transformed:
```{r}
bayesplot::mcmc_areas(as.mcmc(regrid(period.emm)))
```

... and here are intervals for each period compared with its neighbor; we wrap 
the important part of the call in an extra `as.mcmc(as.matrix(...))` so as to
combine the two chains into one.
```{r}
HPDinterval(as.mcmc(as.matrix(
    as.mcmc(contrast(period.emm, "consec", reverse = TRUE), names = FALSE))))
```
The only interval that excludes zero is the one that compares periods 1 and 2.

In summary, to do Bayesian analysis in the **emmeans** package, use the same tools that are available for other models, extract the MCMC samples using `as.mcmc()`, and summarize or plot from there.
