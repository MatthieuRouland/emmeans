---
title: "Pigs example"
author: "Russ Lenth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pigs example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, echo = FALSE, results = "hide", message = FALSE}
require("emmeans")
knitr::opts_chunk$set(collapse = TRUE, fig.width = 4.5)
```

This is a simple example of an unbalanced experiment with two factors that do
not interact strongly. It helps illustrate basic use of the package, the need
for estimated marginal means, handling of a `factor()` call in the model, and
response transformations. The response variable is `conc` and the predictors are 
`source` (factor with 3 levels) and `percent (numeric with four values).
For data details, see `help("pigs")`.

## Exploration
Examination of residual plots from preliminary models suggests that it is a good
idea to work in terms of log concentration.
Here is a basic interaction plot of the logged concentration means:
```{r}
par(mar = .1 + c(4,4,1,1))
with(pigs, interaction.plot(percent, source, log(conc)))
```

## Model
We treat the predictor `percent` as a factor, which we will make happen as 
part of the model formula:
```{r}
pigs.lm <- lm(log(conc) ~ source + factor(percent), data = pigs)
```
With this transformation:
```{r}
anova(pigs.lm, update(pigs.lm, . ~ . + source:factor(percent)))
```
The residual sum of squares does not decrease much; the interaction effect 
is not statistically strong.

For comparison with the raw interaction plot above, here is an analogous plot
of the fitted values from the model. Since the model has no interaction, the
plot shows no interaction either.
```{r}
emmip(pigs.lm, source ~ percent)
```

## EMMs
Since the model is additive (no interactions), it is appropriate to average
the predictions shown in the above graph to obtain the estimated marginal means 
(EMMs):
```{r}
( pigs.emm.s <- emmeans(pigs.lm, "source") )

( pigs.emm.p <- emmeans(pigs.lm, "percent") )
```

## Contrasts
There are various contrasts one could consider. Most natural for `source` might 
be to compare them pairwise:
```{r}
contrast(pigs.emm.s, "pairwise")  ### or just 'pairs(pigs.emm.s)'
```
For `percent`, we might want to look at polynomial contrasts:
```{r}
contrast(pigs.emm.p, "poly")
```

## Simplified model
Only the linear effect is "significant" in the preceding contrast test, so one
might consider a model with only the linear effect of `percent`:
```{r}
pigs.lm2 <- lm(log(conc) ~ source + percent, data = pigs)

emmeans(pigs.lm2, "source")
```
Note that the EMMs for this model are slightly different. That is partly because the models make different predictions; but more importantly, these EMMs are computed on a different reference grid. Let's compare them:
```{r}
ref_grid(pigs.lm)

ref_grid(pigs.lm2)
```
By default, when you have a numeric predictor, its average is used as the *only*
value of that predictor in the reference grid. So, while the `source` EMMs for
`pigs.lm` are computed by averaging predictions with the four `percent`
settings, those for `pigs.lm2` are simply predictions from the model at the
average `percent` value.

## Back-transforming
The models here have a transformed response, so the EMMs shown are on the
`log(conc)` scale (note the annotations in the output try to make this clear). Handling of transformed responses is a complex topic. Please refer to the 
[vignette on transformations and link functions](transformations.html).


